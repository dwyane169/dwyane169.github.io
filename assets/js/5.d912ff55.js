(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{165:function(t,e,s){"use strict";function n(t,e,s,n,r,a,_,o){var i,v="function"==typeof t?t.options:t;if(e&&(v.render=e,v.staticRenderFns=s,v._compiled=!0),n&&(v.functional=!0),a&&(v._scopeId="data-v-"+a),_?(i=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),r&&r.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(_)},v._ssrRegister=i):r&&(i=o?function(){r.call(this,this.$root.$options.shadowRoot)}:r),i)if(v.functional){v._injectStyles=i;var c=v.render;v.render=function(t,e){return i.call(e),c(t,e)}}else{var d=v.beforeCreate;v.beforeCreate=d?[].concat(d,i):[i]}return{exports:t,options:v}}s.d(e,"a",function(){return n})},173:function(t,e,s){"use strict";s.r(e);var n=s(165),r=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"content"},[s("h1",{attrs:{id:"小程序"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小程序","aria-hidden":"true"}},[t._v("#")]),t._v(" 小程序")]),t._v(" "),s("h2",{attrs:{id:"登录详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#登录详解","aria-hidden":"true"}},[t._v("#")]),t._v(" 登录详解")]),t._v(" "),s("h3",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("一般而言，小程序请求后台接口分为两种:")]),t._v(" "),s("p",[t._v("1、需要用户信息的（如购物车）"),s("br"),t._v("\n2、不需要用户信息的（如首页）")]),t._v(" "),s("p",[t._v("在用户需要的时候使用户自主授权、而不需要的时候不强迫用户授权"),s("br"),t._v("\n是比较好的交互方案，所以小程序登录就是为此而设计的"),s("br"),t._v("\n理解这一点对理解小程序登录很重要")]),t._v(" "),s("p",[t._v('而需要用户信息的这类接口，自然需要一个可以 "标识" 用户信息的字符串'),s("br"),t._v("\n自定义登录态便是我们自己创造的这样一个标识")]),t._v(" "),s("h3",{attrs:{id:"一、本地查看自定义登录态"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、本地查看自定义登录态","aria-hidden":"true"}},[t._v("#")]),t._v(" 一、本地查看自定义登录态")]),t._v(" "),s("div",{staticClass:"tip custom-block"},[s("p",{staticClass:"custom-block-title"},[t._v("自定义登录态是什么( 简称token )")]),t._v(" "),s("p",[t._v("token通常在小程序中是指"),s("span",{staticStyle:{color:"green"}},[t._v("session_key")]),t._v("\n与"),s("span",{staticStyle:{color:"green"}},[t._v("openid")]),t._v("两者结合生成的一个字符串"),s("br"),t._v("\n作用是用来标记用户身份信息")])]),t._v(" "),s("div",{staticClass:"tip custom-block"},[s("p",{staticClass:"custom-block-title"},[t._v("自定义登录态使用")]),t._v(" "),s("p",[t._v("一般而言，token在前端存在于storage中，调用后台接口时，通常作为header的参数"),s("br"),t._v("\n跟随数据一起传入后端")])]),t._v(" "),s("p",[t._v("1、使用"),s("span",{staticStyle:{color:"green"}},[t._v("wx.getStorageSync")]),t._v("来查看本地有无token"),s("br"),t._v("\n2、如果不存在token，则为新用户或新使用小程序，执行登录逻辑"),s("br"),t._v("\n3、如果存在token，执行第二步判断")]),t._v(" "),s("h3",{attrs:{id:"二、登录态是否失效"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、登录态是否失效","aria-hidden":"true"}},[t._v("#")]),t._v(" 二、登录态是否失效")]),t._v(" "),s("div",{staticClass:"tip custom-block"},[s("p",{staticClass:"custom-block-title"},[t._v("session_key")]),t._v(" "),s("p",[t._v("腾讯给的会话秘钥，自带过期时间"),s("br"),t._v("\n所以token与之关联, 也就自带了过期时间")])]),t._v(" "),s("p",[t._v("1、使用"),s("span",{staticStyle:{color:"green"}},[t._v("wx.checksession")]),t._v("来确认"),s("span",{staticStyle:{color:"green"}},[t._v("session_key")]),t._v("是否过期"),s("br"),t._v("\n2、如果session_key有效 直接用本地的token来请求后端接口"),s("br"),t._v("\n3、如果session_key无效 执行登录逻辑")]),t._v(" "),s("h3",{attrs:{id:"三、登录逻辑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、登录逻辑","aria-hidden":"true"}},[t._v("#")]),t._v(" 三、登录逻辑")]),t._v(" "),s("div",{staticClass:"tip custom-block"},[s("p",{staticClass:"custom-block-title"},[t._v("wx.login")]),t._v(" "),s("p",[t._v("小程序官方的登录api"),s("br"),t._v("\n然而并不是真的登录，后面说原因")])]),t._v(" "),s("p",[t._v("1、能走到这一步，证明你的session_key( token ) 要么失效,要么没有"),s("br"),t._v("\n2、使用wx.login 这个api 获取code 然后请求后端"),s("br"),t._v("\n3、后端根据code 去腾讯家拿openid和session_key"),s("br"),t._v("\n4、后端根据openid和session_key生成token返回给前端"),s("br"),t._v("\n5、前端使用wx.setStorageSync把token存到本地，或者覆盖旧的token"),s("br"),t._v("\n6、你可以用这个token 来请求后端数据了"),s("br")]),t._v(" "),s("h3",{attrs:{id:"四、真正的登录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、真正的登录","aria-hidden":"true"}},[t._v("#")]),t._v(" 四、真正的登录")]),t._v(" "),s("p",[t._v("1、你有了token了，它是跟你的session_key紧紧相关的"),s("br"),t._v("\n2、于是可以为所欲为的请求后端的接口"),s("br"),t._v("\n3、但是！"),s("br"),t._v("\n4、你想使用用户个人信息的时候，后端一脸蒙蔽"),s("br"),t._v("\n5、因为你只给了人家code、腾讯也只给了人家两个东西"),s("br"),t._v("\n6、上哪给你用户信息"),s("br"),t._v("\n7、所以，前端需要加个button来让用户自己心甘情愿的授权给你"),s("br"),t._v("\n8、通过授权、把iv encrypted 信息 以及header中的token 给后端"),s("br"),t._v("\n9、后端拿到token 匹配 session_key，然后用session_key和iv,encrypted"),s("br"),t._v("\n10、一起解密用户信息，把用户标记为真的登录。"),s("br"),t._v("\n11、然后你就可以买买买了")])])}],!1,null,null,null);e.default=r.exports}}]);