<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>小程序 | NinJa</title>
    <meta name="description" content="时间太短，指缝太宽">
    <link rel="icon" href="/icon.png">
    
    <link rel="preload" href="/assets/css/0.styles.3b34e37a.css" as="style"><link rel="preload" href="/assets/js/app.baee5b2c.js" as="script"><link rel="preload" href="/assets/js/5.d912ff55.js" as="script"><link rel="prefetch" href="/assets/js/2.32b8d54c.js"><link rel="prefetch" href="/assets/js/3.61c2301f.js"><link rel="prefetch" href="/assets/js/4.009c952f.js"><link rel="prefetch" href="/assets/js/6.5a642ef0.js"><link rel="prefetch" href="/assets/js/7.66ec18b2.js"><link rel="prefetch" href="/assets/js/8.d3bed891.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3b34e37a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NinJa</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">总览</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/miniprogram/" class="nav-link router-link-exact-active router-link-active">小程序</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><a href="/practice/" class="nav-link">MD语法练习</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">总览</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/miniprogram/" class="nav-link router-link-exact-active router-link-active">小程序</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><a href="/practice/" class="nav-link">MD语法练习</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/miniprogram/" class="active sidebar-link">小程序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/miniprogram/#登录详解" class="sidebar-link">登录详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/miniprogram/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/miniprogram/#一、本地查看自定义登录态" class="sidebar-link">一、本地查看自定义登录态</a></li><li class="sidebar-sub-header"><a href="/miniprogram/#二、登录态是否失效" class="sidebar-link">二、登录态是否失效</a></li><li class="sidebar-sub-header"><a href="/miniprogram/#三、登录逻辑" class="sidebar-link">三、登录逻辑</a></li><li class="sidebar-sub-header"><a href="/miniprogram/#四、真正的登录" class="sidebar-link">四、真正的登录</a></li></ul></li></ul></li></ul> </div> <div class="page"> <div class="content"><h1 id="小程序"><a href="#小程序" aria-hidden="true" class="header-anchor">#</a> 小程序</h1> <h2 id="登录详解"><a href="#登录详解" aria-hidden="true" class="header-anchor">#</a> 登录详解</h2> <h3 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h3> <p>一般而言，小程序请求后台接口分为两种:</p> <p>1、需要用户信息的（如购物车）<br>
2、不需要用户信息的（如首页）</p> <p>在用户需要的时候使用户自主授权、而不需要的时候不强迫用户授权<br>
是比较好的交互方案，所以小程序登录就是为此而设计的<br>
理解这一点对理解小程序登录很重要</p> <p>而需要用户信息的这类接口，自然需要一个可以 &quot;标识&quot; 用户信息的字符串<br>
自定义登录态便是我们自己创造的这样一个标识</p> <h3 id="一、本地查看自定义登录态"><a href="#一、本地查看自定义登录态" aria-hidden="true" class="header-anchor">#</a> 一、本地查看自定义登录态</h3> <div class="tip custom-block"><p class="custom-block-title">自定义登录态是什么( 简称token )</p> <p>token通常在小程序中是指<span style="color:green">session_key</span>
与<span style="color:green">openid</span>两者结合生成的一个字符串<br>
作用是用来标记用户身份信息</p></div> <div class="tip custom-block"><p class="custom-block-title">自定义登录态使用</p> <p>一般而言，token在前端存在于storage中，调用后台接口时，通常作为header的参数<br>
跟随数据一起传入后端</p></div> <p>1、使用<span style="color:green">wx.getStorageSync</span>来查看本地有无token<br>
2、如果不存在token，则为新用户或新使用小程序，执行登录逻辑<br>
3、如果存在token，执行第二步判断</p> <h3 id="二、登录态是否失效"><a href="#二、登录态是否失效" aria-hidden="true" class="header-anchor">#</a> 二、登录态是否失效</h3> <div class="tip custom-block"><p class="custom-block-title">session_key</p> <p>腾讯给的会话秘钥，自带过期时间<br>
所以token与之关联, 也就自带了过期时间</p></div> <p>1、使用<span style="color:green">wx.checksession</span>来确认<span style="color:green">session_key</span>是否过期<br>
2、如果session_key有效 直接用本地的token来请求后端接口<br>
3、如果session_key无效 执行登录逻辑</p> <h3 id="三、登录逻辑"><a href="#三、登录逻辑" aria-hidden="true" class="header-anchor">#</a> 三、登录逻辑</h3> <div class="tip custom-block"><p class="custom-block-title">wx.login</p> <p>小程序官方的登录api<br>
然而并不是真的登录，后面说原因</p></div> <p>1、能走到这一步，证明你的session_key( token ) 要么失效,要么没有<br>
2、使用wx.login 这个api 获取code 然后请求后端<br>
3、后端根据code 去腾讯家拿openid和session_key<br>
4、后端根据openid和session_key生成token返回给前端<br>
5、前端使用wx.setStorageSync把token存到本地，或者覆盖旧的token<br>
6、你可以用这个token 来请求后端数据了<br></p> <h3 id="四、真正的登录"><a href="#四、真正的登录" aria-hidden="true" class="header-anchor">#</a> 四、真正的登录</h3> <p>1、你有了token了，它是跟你的session_key紧紧相关的<br>
2、于是可以为所欲为的请求后端的接口<br>
3、但是！<br>
4、你想使用用户个人信息的时候，后端一脸蒙蔽<br>
5、因为你只给了人家code、腾讯也只给了人家两个东西<br>
6、上哪给你用户信息<br>
7、所以，前端需要加个button来让用户自己心甘情愿的授权给你<br>
8、通过授权、把iv encrypted 信息 以及header中的token 给后端<br>
9、后端拿到token 匹配 session_key，然后用session_key和iv,encrypted<br>
10、一起解密用户信息，把用户标记为真的登录。<br>
11、然后你就可以买买买了</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.baee5b2c.js" defer></script><script src="/assets/js/5.d912ff55.js" defer></script>
  </body>
</html>
